<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/BlogPosting" >
  <link rel="stylesheet" type="text/css" href="/assets/css/screen.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Source+Code+Pro">
  <link rel="stylesheet" type="text/css" href="/assets/css/custom.css" />
  <link rel="stylesheet" type="text/css" href="/assets/css/grid.css">
  <link rel="stylesheet" type="text/css" href="/assets/css/jupyter.css">
  <link rel="stylesheet" type="text/css" href="/assets/css/notebook.css">
  <body>
    <section class="post">

    <article role="article" id="post" class="post-content" itemprop="articleBody">
    <p>Predicting whether or not a loan will be paid off on time.</p>

<!--end-->

<h1 id="lending-club">Lending Club</h1>

<p><strong>Identify loans that have a better chance of being paid off on time.</strong></p>

<h1 id="1-about-lending-club">1. About Lending Club</h1>

<p>We will be working with financial lending data from <a href="https://www.lendingclub.com/">Lending Club</a>. <strong>Lending Club</strong> is America’s largest marketplace connecting borrowers and investors, where consumers and small business owners lower the cost of their credit and enjoy a better experience than traditional bank lending, and investors earn attractive risk-adjusted returns.</p>

<p><strong><a href="https://www.lendingclub.com/public/how-peer-lending-works.action">How does an online credit marketplace work?</a></strong></p>

<ul>
  <li>Customers interested in a loan complete a simple application at LendingClub.com</li>
  <li>We leverage online data and technology to quickly assess risk, determine a credit rating and assign appropriate interest rates. Qualified applicants receive offers in just minutes and can evaluate loan options with no impact to their credit score</li>
  <li>Investors ranging from individuals to institutions select loans in which to invest and can earn monthly returns</li>
</ul>

<p><strong>Here is a diagram of the process:</strong>
<img src="/assets/media/loans/how-peer-lending-works.jpg" alt="HOW-PEER-LENDING-WORKS" /></p>

<h1 id="2-the-data">2. The Data</h1>

<p>Lending Club releases data for all of the approved and declined loan applications periodically on their <a href="https://www.lendingclub.com/info/download-data.action">website</a>. We will be focusing on the approved loans data from 2007 to 2011, since a good number of the loans have already finished. In the datasets for later years, many of the loans are current and still being paid off.</p>

<p>The Data Dictionary contains information about what each column represents in the dataset and can be found <a href="https://goo.gl/K4Hi5j">here</a>.</p>

<p>There are three sections to the Data Dictionary:</p>
<ul>
  <li><strong>LoanStats</strong> describes the approved loans dataset</li>
  <li><strong>RejectStats</strong> describes the rejected loans dataset</li>
  <li><strong>BrowseNotes</strong> describes additional information on loans in the dataset</li>
</ul>

<p>Since rejected applications don’t appear on the Lending Club marketplace and aren’t available for investment, we will be focusing on data for approved loans only.</p>

<p>The approved loans datasets contain information on current loans, completed loans, and defaulted loans.</p>

<p>Before we can start doing machine learning, we need to define what features we want to use and which column repesents the target column we want to predict. Let’s start by reading in the dataset and exploring it.</p>

<h1 id="3-acquire-the-data">3. Acquire The Data</h1>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="n">loans_2007</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">"LoanStats3a.csv"</span><span class="p">)</span>
<span class="n">loans_2007</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>
</div>

<p>We need to format the data as followed:</p>

<ol>
  <li>Remove the first row:
    <ul>
      <li>The first row contains notes by <a href="https://www.lendingclub.com/info/prospectus.action">Prospectus</a> instead of the column names and prevents the dataset from being parsed correctly</li>
    </ul>
  </li>
  <li>Remove the <code class="highlighter-rouge">desc</code> column:
    <ul>
      <li>Contains a long text explanation for each loan</li>
    </ul>
  </li>
  <li>Remove the <code class="highlighter-rouge">url</code> column:
    <ul>
      <li>Contains a link to each loan on Lending Club which can only be accessed with an investor account</li>
    </ul>
  </li>
  <li>Remove all columns containing more than 50% missing values:
    <ul>
      <li>Allows us to move more efficiently since we can spend less time trying to fill in these values</li>
    </ul>
  </li>
</ol>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">loans_2007</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'LoanStats3a.csv'</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">half_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">loans_2007</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">loans_2007</span> <span class="o">=</span> <span class="n">loans_2007</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">thresh</span><span class="o">=</span><span class="n">half_count</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">loans_2007</span> <span class="o">=</span> <span class="n">loans_2007</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">'desc'</span><span class="p">,</span> <span class="s">'url'</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">loans_2007</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'loans_2007.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre>
</div>

<p>We will maintain the original dataset <code class="highlighter-rouge">LoanStats3a.csv</code> by filtering out our newly parsed dataset into <code class="highlighter-rouge">loans_2007.csv</code></p>

<h3 id="31-creating-a-pandas-dataframe">3.1 Creating a Pandas DataFrame</h3>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="n">pandas</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s">'display.max_columns'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
<span class="n">pandas</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s">'display.max_rows'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="n">loans_2007</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">"loans_2007.csv"</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">loans_2007</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">loans_2007</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">loans_2007</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>(42538, 52)
</code></pre>
</div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>member_id</th>
      <th>loan_amnt</th>
      <th>funded_amnt</th>
      <th>funded_amnt_inv</th>
      <th>term</th>
      <th>int_rate</th>
      <th>installment</th>
      <th>grade</th>
      <th>sub_grade</th>
      <th>...</th>
      <th>last_pymnt_amnt</th>
      <th>last_credit_pull_d</th>
      <th>collections_12_mths_ex_med</th>
      <th>policy_code</th>
      <th>application_type</th>
      <th>acc_now_delinq</th>
      <th>chargeoff_within_12_mths</th>
      <th>delinq_amnt</th>
      <th>pub_rec_bankruptcies</th>
      <th>tax_liens</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1077501</td>
      <td>1296599.0</td>
      <td>5000.0</td>
      <td>5000.0</td>
      <td>4975.0</td>
      <td>36 months</td>
      <td>10.65%</td>
      <td>162.87</td>
      <td>B</td>
      <td>B2</td>
      <td>...</td>
      <td>171.62</td>
      <td>Jun-2016</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>INDIVIDUAL</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1077430</td>
      <td>1314167.0</td>
      <td>2500.0</td>
      <td>2500.0</td>
      <td>2500.0</td>
      <td>60 months</td>
      <td>15.27%</td>
      <td>59.83</td>
      <td>C</td>
      <td>C4</td>
      <td>...</td>
      <td>119.66</td>
      <td>Sep-2013</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>INDIVIDUAL</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1077175</td>
      <td>1313524.0</td>
      <td>2400.0</td>
      <td>2400.0</td>
      <td>2400.0</td>
      <td>36 months</td>
      <td>15.96%</td>
      <td>84.33</td>
      <td>C</td>
      <td>C5</td>
      <td>...</td>
      <td>649.91</td>
      <td>Jun-2016</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>INDIVIDUAL</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1076863</td>
      <td>1277178.0</td>
      <td>10000.0</td>
      <td>10000.0</td>
      <td>10000.0</td>
      <td>36 months</td>
      <td>13.49%</td>
      <td>339.31</td>
      <td>C</td>
      <td>C1</td>
      <td>...</td>
      <td>357.48</td>
      <td>Apr-2016</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>INDIVIDUAL</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1075358</td>
      <td>1311748.0</td>
      <td>3000.0</td>
      <td>3000.0</td>
      <td>3000.0</td>
      <td>60 months</td>
      <td>12.69%</td>
      <td>67.79</td>
      <td>B</td>
      <td>B5</td>
      <td>...</td>
      <td>67.79</td>
      <td>Jun-2016</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>INDIVIDUAL</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 52 columns</p>
</div>

<h1 id="4-parse-the-data">4. Parse The Data</h1>

<p>By exploring the data set and utilizing our understanding of the Data Dictionary we are going to:</p>

<ol>
  <li>
    <p>Seperate the dataset into 3 groups</p>
  </li>
  <li>Watch out for data leakage
    <ul>
      <li>This can cause our model to overfit, and occures when the model uses data about the target column that wouldn’t be available when using the model on future loans.</li>
    </ul>
  </li>
  <li>Identify features that don’t affect a borrower’s ability to pay back a loan
    <ul>
      <li>(e.g. a randomly generated ID value by Lending Club)</li>
    </ul>
  </li>
  <li>
    <p>Clean poorly formatted features</p>
  </li>
  <li>
    <p>Explore features that require more data or a lot of processing to be useful</p>
  </li>
  <li>
    <p>Determine if any of the features contain redundant information</p>
  </li>
  <li>Select the target column for when we move on to the machine learning phase</li>
</ol>

<h3 id="41-group-1">4.1 Group 1</h3>
<p><img src="/assets/media/loans/group-one.png" alt="GROUP-ONE" /></p>

<p>After analyzing each column, we can conclude that the following features need to be removed:</p>

<ul>
  <li><code class="highlighter-rouge">id</code>: randomly generated field by Lending Club for unique identification purposes only</li>
  <li><code class="highlighter-rouge">member_id</code>: also a randomly generated field by Lending Club for unique identification purposes only</li>
  <li><code class="highlighter-rouge">funded_amnt</code>: leaks data from the future (after the loan is already started to be funded)</li>
  <li><code class="highlighter-rouge">funded_amnt_inv</code>: also leaks data from the future (after the loan is already started to be funded)</li>
  <li><code class="highlighter-rouge">grade</code>: contains redundant information as the interest rate column (int_rate)</li>
  <li><code class="highlighter-rouge">sub_grade</code>: also contains redundant information as the interest rate column (int_rate)</li>
  <li><code class="highlighter-rouge">emp_title</code>: requires other data and a lot of processing to potentially be useful</li>
  <li><code class="highlighter-rouge">issue_d</code>: leaks data from the future (after the loan is already completed funded)</li>
</ul>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">loans_2007</span> <span class="o">=</span> <span class="n">loans_2007</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">"id"</span><span class="p">,</span> <span class="s">"member_id"</span><span class="p">,</span> <span class="s">"funded_amnt"</span><span class="p">,</span> <span class="s">"funded_amnt_inv"</span><span class="p">,</span> <span class="s">"grade"</span><span class="p">,</span> <span class="s">"sub_grade"</span><span class="p">,</span> <span class="s">"emp_title"</span><span class="p">,</span> <span class="s">"issue_d"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>

<p>Lending Club assigns a grade and a sub-grade based on the borrower’s interest rate. While the <code class="highlighter-rouge">grade</code> and <code class="highlighter-rouge">sub_grade</code> values are categorical, the <code class="highlighter-rouge">int_rate</code> column contains continuous values, which are better suited for machine learning.</p>

<h3 id="42-group-2">4.2 Group 2</h3>
<p><img src="/assets/media/loans/group-two.png" alt="GROUP-TWO" /></p>

<p>Within this group of columns, we need to drop the following columns:</p>

<ul>
  <li><code class="highlighter-rouge">zip_code</code>: redundant with the addr_state column since only the first 3 digits of the 5 digit zip code are visible (which only can be used to identify the state the borrower lives in)</li>
  <li><code class="highlighter-rouge">out_prncp</code>: leaks data from the future, (after the loan already started to be paid off)</li>
  <li><code class="highlighter-rouge">out_prncp_inv</code>: also leaks data from the future, (after the loan already started to be paid off)</li>
  <li><code class="highlighter-rouge">total_pymnt</code>: also leaks data from the future, (after the loan already started to be paid off)</li>
  <li><code class="highlighter-rouge">total_pymnt_inv</code>: also leaks data from the future, (after the loan already started to be paid off)</li>
  <li><code class="highlighter-rouge">total_rec_prncp</code>: also leaks data from the future, (after the loan already started to be paid off)</li>
</ul>

<p>The <code class="highlighter-rouge">out_prncp</code> and <code class="highlighter-rouge">out_prncp_inv</code> both describe the outstanding principal amount for a loan, which is the remaining amount the borrower still owes. These 2 columns as well as the <code class="highlighter-rouge">total_pymnt</code> column describe properties of the loan after it’s fully funded and started to be paid off. This information isn’t available to an investor before the loan is fully funded and we don’t want to include it in our model.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">loans_2007</span> <span class="o">=</span> <span class="n">loans_2007</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">"zip_code"</span><span class="p">,</span> <span class="s">"out_prncp"</span><span class="p">,</span> <span class="s">"out_prncp_inv"</span><span class="p">,</span> <span class="s">"total_pymnt"</span><span class="p">,</span> <span class="s">"total_pymnt_inv"</span><span class="p">,</span> <span class="s">"total_rec_prncp"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>

<h3 id="43-group-3">4.3 Group 3</h3>
<p><img src="/assets/media/loans/group-three.png" alt="GROUP-THREE" /></p>

<p>In the last group of columns, we need to drop the following columns:</p>

<ul>
  <li><code class="highlighter-rouge">total_rec_int</code>: leaks data from the future, (after the loan already started to be paid off)</li>
  <li><code class="highlighter-rouge">total_rec_late_fee</code>: also leaks data from the future, (after the loan already started to be paid off)</li>
  <li><code class="highlighter-rouge">recoveries</code>: also leaks data from the future, (after the loan already started to be paid off)</li>
  <li><code class="highlighter-rouge">collection_recovery_fee</code>: also leaks data from the future, (after the loan already started to be paid off)</li>
  <li><code class="highlighter-rouge">last_pymnt_d</code>: also leaks data from the future, (after the loan already started to be paid off)</li>
  <li><code class="highlighter-rouge">last_pymnt_amnt</code>: also leaks data from the future, (after the loan already started to be paid off)</li>
</ul>

<p>All of these columns leak data from the future, meaning that they’re describing aspects of the loan after it’s already been fully funded and started to be paid off by the borrower.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">loans_2007</span> <span class="o">=</span> <span class="n">loans_2007</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">"total_rec_int"</span><span class="p">,</span> <span class="s">"total_rec_late_fee"</span><span class="p">,</span> <span class="s">"recoveries"</span><span class="p">,</span> <span class="s">"collection_recovery_fee"</span><span class="p">,</span> <span class="s">"last_pymnt_d"</span><span class="p">,</span> <span class="s">"last_pymnt_amnt"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">loans_2007</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">loans_2007</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>(42538, 32)
</code></pre>
</div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>term</th>
      <th>int_rate</th>
      <th>installment</th>
      <th>emp_length</th>
      <th>home_ownership</th>
      <th>annual_inc</th>
      <th>verification_status</th>
      <th>loan_status</th>
      <th>pymnt_plan</th>
      <th>...</th>
      <th>initial_list_status</th>
      <th>last_credit_pull_d</th>
      <th>collections_12_mths_ex_med</th>
      <th>policy_code</th>
      <th>application_type</th>
      <th>acc_now_delinq</th>
      <th>chargeoff_within_12_mths</th>
      <th>delinq_amnt</th>
      <th>pub_rec_bankruptcies</th>
      <th>tax_liens</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5000.0</td>
      <td>36 months</td>
      <td>10.65%</td>
      <td>162.87</td>
      <td>10+ years</td>
      <td>RENT</td>
      <td>24000.0</td>
      <td>Verified</td>
      <td>Fully Paid</td>
      <td>n</td>
      <td>...</td>
      <td>f</td>
      <td>Jun-2016</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>INDIVIDUAL</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2500.0</td>
      <td>60 months</td>
      <td>15.27%</td>
      <td>59.83</td>
      <td>&lt; 1 year</td>
      <td>RENT</td>
      <td>30000.0</td>
      <td>Source Verified</td>
      <td>Charged Off</td>
      <td>n</td>
      <td>...</td>
      <td>f</td>
      <td>Sep-2013</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>INDIVIDUAL</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2400.0</td>
      <td>36 months</td>
      <td>15.96%</td>
      <td>84.33</td>
      <td>10+ years</td>
      <td>RENT</td>
      <td>12252.0</td>
      <td>Not Verified</td>
      <td>Fully Paid</td>
      <td>n</td>
      <td>...</td>
      <td>f</td>
      <td>Jun-2016</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>INDIVIDUAL</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10000.0</td>
      <td>36 months</td>
      <td>13.49%</td>
      <td>339.31</td>
      <td>10+ years</td>
      <td>RENT</td>
      <td>49200.0</td>
      <td>Source Verified</td>
      <td>Fully Paid</td>
      <td>n</td>
      <td>...</td>
      <td>f</td>
      <td>Apr-2016</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>INDIVIDUAL</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3000.0</td>
      <td>60 months</td>
      <td>12.69%</td>
      <td>67.79</td>
      <td>1 year</td>
      <td>RENT</td>
      <td>80000.0</td>
      <td>Source Verified</td>
      <td>Current</td>
      <td>n</td>
      <td>...</td>
      <td>f</td>
      <td>Jun-2016</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>INDIVIDUAL</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 32 columns</p>
</div>

<p>We were able to reduce the number of columns from 52 to 32 columns. Now we need to decide on a target column that we want to use for modeling.</p>

<h3 id="44-target-column">4.4 Target Column</h3>

<p>The <strong>loan_status</strong> column is the only column that directly describes if a loan was paid off on time, had delayed payments, or was defaulted on the borrower. This column contains text values and needs to be converted to a numerical column for training our model.</p>

<p>We will use the <code class="highlighter-rouge">value_counts()</code> method to display the frequency of each unique value. This will allow us to explore the different values in this column and come up with a strategy for converting them.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">loans_2007</span><span class="p">[</span><span class="s">'loan_status'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>Fully Paid                                             33136
Charged Off                                             5634
Does not meet the credit policy. Status:Fully Paid      1988
Current                                                  961
Does not meet the credit policy. Status:Charged Off      761
Late (31-120 days)                                        24
In Grace Period                                           20
Late (16-30 days)                                          8
Default                                                    3
Name: loan_status, dtype: int64
</code></pre>
</div>

<h3 id="45-the-quality-of-the-data">4.5 The Quality of The Data</h3>

<h4 id="binary-classification">Binary Classification</h4>

<p>There are 8 different possible values for the <code class="highlighter-rouge">loan_status</code> column. The following table provides insight on each column as well as the counts in the Dataframe:</p>

<p><img src="/assets/media/loans/loan_status.png" alt="LOAN-STATUS" /></p>

<p>From an investor’s point of view, we are interested in trying to predict if a loan will be paid off on time or not. Only the <code class="highlighter-rouge">Fully Paid</code> and <code class="highlighter-rouge">Charged Off</code> values describe the final outcome of the loan. The other values describe loans that are still on going. Loans with a <code class="highlighter-rouge">Charged Off</code> status essentially have no chance of being repaid, and loans marked with a <code class="highlighter-rouge">Default</code> status have only a small chance of being repaid.</p>

<p>Since we are only interested in predicting which of these 2 values (<code class="highlighter-rouge">Fully Paid</code> and <code class="highlighter-rouge">Charged Off</code>) a loan will fall under, we can establish that this is a <strong>binary classification</strong> problem.</p>

<p>We can start by removing all the loans that don’t contain either a <code class="highlighter-rouge">Fully Paid</code> or <code class="highlighter-rouge">Charged Off</code> loan status and then assign the <code class="highlighter-rouge">Fully Paid</code> values to <code class="highlighter-rouge">1</code> for the positive case and the <code class="highlighter-rouge">Charged Off</code> values to <code class="highlighter-rouge">0</code> for the negative case. While there are a few different ways to transform all of the values in a column, we’ll use the Dataframe method replace.</p>

<h4 id="class-imbalance">Class Imbalance</h4>

<p>One thing to keep in mind is the <strong>class imbalance</strong> between the positive and negative cases. While there are 33,136 loans that have been fully paid off, there are only 5,634 that were charged off. This class imbalance may result in the model having a stronger bias towards predicting the class with more observations. The stronger the imbalance, the more biased the model becomes.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">loans_2007</span> <span class="o">=</span> <span class="n">loans_2007</span><span class="p">[(</span><span class="n">loans_2007</span><span class="p">[</span><span class="s">'loan_status'</span><span class="p">]</span> <span class="o">==</span> <span class="s">"Fully Paid"</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">loans_2007</span><span class="p">[</span><span class="s">'loan_status'</span><span class="p">]</span> <span class="o">==</span> <span class="s">"Charged Off"</span><span class="p">)]</span>

<span class="n">status_replace</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"loan_status"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s">"Fully Paid"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">"Charged Off"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">loans_2007</span> <span class="o">=</span> <span class="n">loans_2007</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">status_replace</span><span class="p">)</span>
</code></pre>
</div>

<h4 id="reducing-data-size">Reducing Data Size</h4>

<p>We can also further reduce the size of our data set by identifying columns that contain only one unique value. These columns won’t be useful for the model since they don’t add any information to each loan application.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">orig_columns</span> <span class="o">=</span> <span class="n">loans_2007</span><span class="o">.</span><span class="n">columns</span>
<span class="n">drop_columns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">orig_columns</span><span class="p">:</span>
    <span class="n">col_series</span> <span class="o">=</span> <span class="n">loans_2007</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_series</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">drop_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
<span class="n">loans_2007</span> <span class="o">=</span> <span class="n">loans_2007</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>['pymnt_plan', 'initial_list_status', 'collections_12_mths_ex_med', 'policy_code', 'application_type', 'acc_now_delinq', 'chargeoff_within_12_mths', 'delinq_amnt', 'tax_liens']
</code></pre>
</div>

<p>We were able to remove 9 more columns since they only contained 1 unique value.</p>

<p>Let’s export our DataFrame and save it to a new <code class="highlighter-rouge">filtered_loans_2007.csv</code> file</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">loans_2007</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'filtered_loans_2007.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre>
</div>

<h1 id="5-mine-the-data">5. Mine The Data</h1>

<p>We need to make sure there are no missing values in the DataFrame, otherwise Scikit-learn will throw an error if you try to train a model using data that contain any missing or non-numerical values.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">loans</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'filtered_loans_2007.csv'</span><span class="p">)</span>
<span class="n">null_counts</span> <span class="o">=</span> <span class="n">loans</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
<span class="n">null_counts</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>loan_amnt                 0
term                      0
int_rate                  0
installment               0
emp_length                0
home_ownership            0
annual_inc                0
verification_status       0
loan_status               0
purpose                   0
title                    10
addr_state                0
dti                       0
delinq_2yrs               0
earliest_cr_line          0
inq_last_6mths            0
open_acc                  0
pub_rec                   0
revol_bal                 0
revol_util               50
total_acc                 0
last_credit_pull_d        2
pub_rec_bankruptcies    697
dtype: int64
</code></pre>
</div>

<h3 id="51-handling-missing-values">5.1 Handling Missing Values</h3>

<p>We can keep the following columns and just remove columns where more than 1% of the rows contain missing values:</p>

<ol>
  <li><code class="highlighter-rouge">pub_rec_bankruptcies</code>
    <ul>
      <li>We should remove this column first because it contains the most rows with missing values</li>
    </ul>
  </li>
  <li>
    <p><code class="highlighter-rouge">title</code></p>
  </li>
  <li>
    <p><code class="highlighter-rouge">revol_util</code></p>
  </li>
  <li><code class="highlighter-rouge">last_credit_pull_d</code></li>
</ol>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">loans</span> <span class="o">=</span> <span class="n">loans</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">"pub_rec_bankruptcies"</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">loans</span> <span class="o">=</span> <span class="n">loans</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre>
</div>

<h3 id="52-handling-non-numeric-values">5.2 Handling Non-numeric Values</h3>

<p>We need to identify each columns data type and return the count</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">loans</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>object     11
float64    10
int64       1
dtype: int64
</code></pre>
</div>

<p>The object columns that contain text need to be converted to numerical data types.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">object_columns_df</span> <span class="o">=</span> <span class="n">loans</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s">"object"</span><span class="p">])</span>
<span class="n">object_columns_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>
</div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>term</th>
      <th>int_rate</th>
      <th>emp_length</th>
      <th>home_ownership</th>
      <th>verification_status</th>
      <th>purpose</th>
      <th>title</th>
      <th>addr_state</th>
      <th>earliest_cr_line</th>
      <th>revol_util</th>
      <th>last_credit_pull_d</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>36 months</td>
      <td>10.65%</td>
      <td>10+ years</td>
      <td>RENT</td>
      <td>Verified</td>
      <td>credit_card</td>
      <td>Computer</td>
      <td>AZ</td>
      <td>Jan-1985</td>
      <td>83.7%</td>
      <td>Jun-2016</td>
    </tr>
    <tr>
      <th>1</th>
      <td>60 months</td>
      <td>15.27%</td>
      <td>&lt; 1 year</td>
      <td>RENT</td>
      <td>Source Verified</td>
      <td>car</td>
      <td>bike</td>
      <td>GA</td>
      <td>Apr-1999</td>
      <td>9.4%</td>
      <td>Sep-2013</td>
    </tr>
    <tr>
      <th>2</th>
      <td>36 months</td>
      <td>15.96%</td>
      <td>10+ years</td>
      <td>RENT</td>
      <td>Not Verified</td>
      <td>small_business</td>
      <td>real estate business</td>
      <td>IL</td>
      <td>Nov-2001</td>
      <td>98.5%</td>
      <td>Jun-2016</td>
    </tr>
    <tr>
      <th>3</th>
      <td>36 months</td>
      <td>13.49%</td>
      <td>10+ years</td>
      <td>RENT</td>
      <td>Source Verified</td>
      <td>other</td>
      <td>personel</td>
      <td>CA</td>
      <td>Feb-1996</td>
      <td>21%</td>
      <td>Apr-2016</td>
    </tr>
    <tr>
      <th>4</th>
      <td>36 months</td>
      <td>7.90%</td>
      <td>3 years</td>
      <td>RENT</td>
      <td>Source Verified</td>
      <td>wedding</td>
      <td>My wedding loan I promise to pay back</td>
      <td>AZ</td>
      <td>Nov-2004</td>
      <td>28.3%</td>
      <td>Jan-2016</td>
    </tr>
  </tbody>
</table>
</div>

<h1 id="6-refine-the-data">6. Refine The Data</h1>

<p>Columns that represent categorical values:</p>

<ul>
  <li><code class="highlighter-rouge">home_ownership</code>: Can only be 1 of 4 categorical values based on the Data Dictionary</li>
  <li><code class="highlighter-rouge">verification_status</code>: Indicates if income was verified by Lending Club</li>
  <li><code class="highlighter-rouge">emp_length</code>: Number of years the borrower was employed at the time of applying</li>
  <li><code class="highlighter-rouge">term</code>: Number of payments on the loan, either 36 or 60</li>
  <li><code class="highlighter-rouge">addr_state</code>: Borrower’s state of residence</li>
  <li><code class="highlighter-rouge">purpose</code>: A category provided by the borrower for the loan request</li>
  <li><code class="highlighter-rouge">title</code>: Loan title provided the borrower</li>
</ul>

<p>Columns that represent numeric values:</p>

<ul>
  <li><code class="highlighter-rouge">int_rate</code>: Interest rate of the loan in %</li>
  <li><code class="highlighter-rouge">revol_util</code>: Revolving Line Utilization Rate or the amount of credit the borrower is using relative to all available credit</li>
</ul>

<p>Columns containing date values that require feature engineering will be removed:</p>

<ul>
  <li><code class="highlighter-rouge">earliest_cr_line</code>: The month the borrower’s earliest reported credit line was opened</li>
  <li><code class="highlighter-rouge">last_credit_pull_d</code>: The most recent month Lending Club pulled credit for this loan</li>
</ul>

<h3 id="61-categorical-values">6.1 Categorical Values</h3>
<p>Here is the unique value counts of the columnns that could potentially contain categorical values.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'home_ownership'</span><span class="p">,</span> <span class="s">'verification_status'</span><span class="p">,</span> <span class="s">'emp_length'</span><span class="p">,</span> <span class="s">'term'</span><span class="p">,</span> <span class="s">'addr_state'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>RENT        18513
MORTGAGE    17112
OWN          2984
OTHER          96
NONE            3
Name: home_ownership, dtype: int64
Not Verified       16696
Verified           12290
Source Verified     9722
Name: verification_status, dtype: int64
10+ years    8545
&lt; 1 year     4513
2 years      4303
3 years      4022
4 years      3353
5 years      3202
1 year       3176
6 years      2177
7 years      1714
8 years      1442
9 years      1229
n/a          1032
Name: emp_length, dtype: int64
 36 months    29041
 60 months     9667
Name: term, dtype: int64
CA    6958
NY    3713
FL    2791
TX    2667
NJ    1798
IL    1483
PA    1473
VA    1376
GA    1364
MA    1301
OH    1179
MD    1026
AZ     850
WA     822
CO     770
NC     753
CT     730
MI     712
MO     671
MN     603
NV     481
SC     462
WI     441
AL     437
OR     436
LA     430
KY     315
OK     290
KS     260
UT     254
AR     237
DC     209
RI     196
NM     184
WV     172
HI     166
NH     166
DE     113
MT      83
WY      80
AK      78
SD      61
VT      53
MS      19
TN      17
IN       9
ID       6
NE       5
IA       5
ME       3
Name: addr_state, dtype: int64
</code></pre>
</div>

<p>Below we will display the unique values of the following columns:</p>

<ul>
  <li><code class="highlighter-rouge">purpose</code></li>
  <li><code class="highlighter-rouge">title</code></li>
</ul>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"purpose"</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"title"</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>debt_consolidation    18130
credit_card            5039
other                  3864
home_improvement       2897
major_purchase         2155
small_business         1762
car                    1510
wedding                 929
medical                 680
moving                  576
vacation                375
house                   369
educational             320
renewable_energy        102
Name: purpose, dtype: int64
Debt Consolidation                                  2104
Debt Consolidation Loan                             1632
Personal Loan                                        642
Consolidation                                        494
debt consolidation                                   485
Credit Card Consolidation                            353
Home Improvement                                     346
Debt consolidation                                   324
Small Business Loan                                  310
Credit Card Loan                                     305
Personal                                             302
Consolidation Loan                                   251
Home Improvement Loan                                234
personal loan                                        227
personal                                             211
Loan                                                 208
Wedding Loan                                         201
Car Loan                                             195
consolidation                                        193
Other Loan                                           181
Credit Card Payoff                                   150
Wedding                                              149
Credit Card Refinance                                143
Major Purchase Loan                                  139
Consolidate                                          125
Medical                                              118
Credit Card                                          115
home improvement                                     107
My Loan                                               92
Credit Cards                                          91
                                                    ... 
Moving expense loan                                    1
get rid of my credit cards loans                       1
My Cessna Airplane Needs Engine Overhaul               1
Remodel office space so it can be leased               1
Happy Day                                              1
Consolidation Nov 2011                                 1
credit card and medical bill consolidati               1
Goodbye to Debt                                        1
Operation Pay Off Parents                              1
Velma Loan                                             1
Med Bills                                              1
Young Engineer Looking For Home Help                   1
Major Buy                                              1
megical                                                1
Debt Consildate CC                                     1
BOA                                                    1
debt free in 36!                                       1
Chase-Citi-Dell-Apple-Exxon                            1
Recently had a baby...                                 1
Debt Free Me !                                         1
Gabi's Car Loan                                        1
Maria Elena                                            1
Credit consolidation and refinance                     1
better opportunities for money saved on interest       1
Consolidation for Wedding Budget                       1
Time to paint the exterior!                            1
CC consolidator                                        1
Education/Furniture                                    1
Riddle family debt consolidation.                      1
Duplex Investment                                      1
Name: title, Length: 19332, dtype: int64
</code></pre>
</div>

<p><strong>Observation:</strong></p>

<ul>
  <li>The <code class="highlighter-rouge">purpose</code> and <code class="highlighter-rouge">title</code> columns contain overlapping information.</li>
  <li>The <code class="highlighter-rouge">purpose</code> column since it contains a few discrete values.</li>
  <li>The <code class="highlighter-rouge">title</code> column has data quality issues. Many of the values are repeated with slight modifications (for example: <code class="highlighter-rouge">Debt Consolidation</code> and <code class="highlighter-rouge">Debt Consolidation Loan</code> and <code class="highlighter-rouge">debt consolidation</code>).</li>
</ul>

<p>The <code class="highlighter-rouge">emp_length</code> column needs to be cleaned and converted to numeric values since they have ordering.</p>

<p>We can use the following mapping to clean the <code class="highlighter-rouge">emp_length</code> column:</p>

<ul>
  <li>“10+ years”: 10</li>
  <li>“9 years”: 9</li>
  <li>“8 years”: 8</li>
  <li>“7 years”: 7</li>
  <li>“6 years”: 6</li>
  <li>“5 years”: 5</li>
  <li>“4 years”: 4</li>
  <li>“3 years”: 3</li>
  <li>“2 years”: 2</li>
  <li>“1 year”: 1</li>
  <li>”&lt; 1 year”: 0</li>
  <li>“n/a”: 0</li>
</ul>

<p>We are going to map all individuals who may have been working more than 10 year to the value of 10.</p>

<p>For the individuals who have worked less than a year or have missing data will be assigned the value of 0.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">mapping_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"emp_length"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"10+ years"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s">"9 years"</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
        <span class="s">"8 years"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s">"7 years"</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="s">"6 years"</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s">"5 years"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s">"4 years"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s">"3 years"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s">"2 years"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s">"1 year"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">"&lt; 1 year"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">"n/a"</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">loans</span> <span class="o">=</span> <span class="n">loans</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">"last_credit_pull_d"</span><span class="p">,</span> <span class="s">"earliest_cr_line"</span><span class="p">,</span> <span class="s">"addr_state"</span><span class="p">,</span> <span class="s">"title"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">loans</span><span class="p">[</span><span class="s">"int_rate"</span><span class="p">]</span> <span class="o">=</span> <span class="n">loans</span><span class="p">[</span><span class="s">"int_rate"</span><span class="p">]</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">"</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">"float"</span><span class="p">)</span>
<span class="n">loans</span><span class="p">[</span><span class="s">"revol_util"</span><span class="p">]</span> <span class="o">=</span> <span class="n">loans</span><span class="p">[</span><span class="s">"revol_util"</span><span class="p">]</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">"</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">"float"</span><span class="p">)</span>
<span class="n">loans</span> <span class="o">=</span> <span class="n">loans</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">mapping_dict</span><span class="p">)</span>
</code></pre>
</div>

<h3 id="62-dummy-variables">6.2 Dummy Variables</h3>

<p>The <code class="highlighter-rouge">home_ownership</code>, <code class="highlighter-rouge">verification_status</code>, <code class="highlighter-rouge">emp_length</code>, and <code class="highlighter-rouge">term</code> columns each contain a few discrete categorical values. We should encode these columns as dummy variables:</p>

<ul>
  <li>Use the Series method <code class="highlighter-rouge">astype</code> to convert each column to the category data type</li>
  <li>Use the <code class="highlighter-rouge">get_dummies</code> function to return a DataFrame containing the dummy columns</li>
  <li>Use the <code class="highlighter-rouge">concat</code> method to add these dummy columns back to <code class="highlighter-rouge">loans</code></li>
  <li>Remove the original, non-dummy columns (<code class="highlighter-rouge">home_ownership</code>, <code class="highlighter-rouge">verification_status</code>, <code class="highlighter-rouge">purpose</code>, and <code class="highlighter-rouge">term</code>) from <code class="highlighter-rouge">loans</code></li>
</ul>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">cat_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">"home_ownership"</span><span class="p">,</span> <span class="s">"verification_status"</span><span class="p">,</span> <span class="s">"purpose"</span><span class="p">,</span> <span class="s">"term"</span><span class="p">]</span>
<span class="n">dummy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="n">cat_columns</span><span class="p">])</span>
<span class="n">loans</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">loans</span><span class="p">,</span> <span class="n">dummy_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">loans</span> <span class="o">=</span> <span class="n">loans</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cat_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>

<p>Save our newly formatted Data:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">loans</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'cleaned_loans_2007.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre>
</div>

<p>Import newly formatted Data:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="n">loans</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">"cleaned_loans_2007.csv"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">loans</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">loans</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 38708 entries, 0 to 38707
Data columns (total 38 columns):
loan_amnt                              38708 non-null float64
int_rate                               38708 non-null float64
installment                            38708 non-null float64
emp_length                             38708 non-null int64
annual_inc                             38708 non-null float64
loan_status                            38708 non-null int64
dti                                    38708 non-null float64
delinq_2yrs                            38708 non-null float64
inq_last_6mths                         38708 non-null float64
open_acc                               38708 non-null float64
pub_rec                                38708 non-null float64
revol_bal                              38708 non-null float64
revol_util                             38708 non-null float64
total_acc                              38708 non-null float64
home_ownership_MORTGAGE                38708 non-null int64
home_ownership_NONE                    38708 non-null int64
home_ownership_OTHER                   38708 non-null int64
home_ownership_OWN                     38708 non-null int64
home_ownership_RENT                    38708 non-null int64
verification_status_Not Verified       38708 non-null int64
verification_status_Source Verified    38708 non-null int64
verification_status_Verified           38708 non-null int64
purpose_car                            38708 non-null int64
purpose_credit_card                    38708 non-null int64
purpose_debt_consolidation             38708 non-null int64
purpose_educational                    38708 non-null int64
purpose_home_improvement               38708 non-null int64
purpose_house                          38708 non-null int64
purpose_major_purchase                 38708 non-null int64
purpose_medical                        38708 non-null int64
purpose_moving                         38708 non-null int64
purpose_other                          38708 non-null int64
purpose_renewable_energy               38708 non-null int64
purpose_small_business                 38708 non-null int64
purpose_vacation                       38708 non-null int64
purpose_wedding                        38708 non-null int64
term_ 36 months                        38708 non-null int64
term_ 60 months                        38708 non-null int64
dtypes: float64(12), int64(26)
memory usage: 11.2 MB
None
</code></pre>
</div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>int_rate</th>
      <th>installment</th>
      <th>emp_length</th>
      <th>annual_inc</th>
      <th>loan_status</th>
      <th>dti</th>
      <th>delinq_2yrs</th>
      <th>inq_last_6mths</th>
      <th>open_acc</th>
      <th>...</th>
      <th>purpose_major_purchase</th>
      <th>purpose_medical</th>
      <th>purpose_moving</th>
      <th>purpose_other</th>
      <th>purpose_renewable_energy</th>
      <th>purpose_small_business</th>
      <th>purpose_vacation</th>
      <th>purpose_wedding</th>
      <th>term_ 36 months</th>
      <th>term_ 60 months</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5000.0</td>
      <td>10.65</td>
      <td>162.87</td>
      <td>10</td>
      <td>24000.0</td>
      <td>1</td>
      <td>27.65</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>3.0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2500.0</td>
      <td>15.27</td>
      <td>59.83</td>
      <td>0</td>
      <td>30000.0</td>
      <td>0</td>
      <td>1.00</td>
      <td>0.0</td>
      <td>5.0</td>
      <td>3.0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2400.0</td>
      <td>15.96</td>
      <td>84.33</td>
      <td>10</td>
      <td>12252.0</td>
      <td>1</td>
      <td>8.72</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10000.0</td>
      <td>13.49</td>
      <td>339.31</td>
      <td>10</td>
      <td>49200.0</td>
      <td>1</td>
      <td>20.00</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>10.0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5000.0</td>
      <td>7.90</td>
      <td>156.46</td>
      <td>3</td>
      <td>36000.0</td>
      <td>1</td>
      <td>11.20</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>9.0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 38 columns</p>
</div>

<h1 id="7-build-a-data-model">7. Build A Data Model</h1>

<h3 id="71-calculating-error-metric">7.1 Calculating Error Metric</h3>

<p>Our error metric will help us figure out whether or not our model is performing well, and will ultimately determine if our algorithm will make us money or lose us money.</p>

<p>In this case, we are primarily concerned with the following misclassifications: false positives and false negatives. Both of these are different types of misclassifications.</p>

<p><strong>1. False Positive</strong></p>
<ul>
  <li>We predict that a loan will be paid off on time, but it actually isn’t.</li>
</ul>

<p><strong>2. False Negative</strong></p>
<ul>
  <li>We predict that a loan won’t be paid off on time, but it actually is paid off on time.</li>
</ul>

<p>We need to treat false positives differently than false negatives. We want to minimize risk, and avoid false positives as much as possible because we would prefer to miss out on opportunities (false negatives) instead of funding a risky loan (false positives).</p>

<p>In the <code class="highlighter-rouge">loan_status</code> and <code class="highlighter-rouge">prediction</code> columns, a <code class="highlighter-rouge">0</code> means that the loan wont be paid off on time, and a <code class="highlighter-rouge">1</code> means that it will be paid off on time.</p>

<ol>
  <li>Find the number of true negatives
    <ul>
      <li>Find the number of items where <code class="highlighter-rouge">predictions</code> is <code class="highlighter-rouge">0</code>, and the corresponding entry in <code class="highlighter-rouge">loans["loan_status"]</code> is also <code class="highlighter-rouge">0</code></li>
      <li>Assign the result to <code class="highlighter-rouge">tn</code></li>
    </ul>
  </li>
  <li>Find the number of true positives
    <ul>
      <li>Find the number of items where <code class="highlighter-rouge">predictions</code> is <code class="highlighter-rouge">1</code>, and the corresponding entry in <code class="highlighter-rouge">loans["loan_status"]</code> is also <code class="highlighter-rouge">1</code></li>
      <li>Assign the result to <code class="highlighter-rouge">tp</code></li>
    </ul>
  </li>
  <li>Find the number of false negatives
    <ul>
      <li>Find the number of items where <code class="highlighter-rouge">predictions</code> is <code class="highlighter-rouge">0</code>, and the corresponding entry in <code class="highlighter-rouge">loans["loan_status"]</code> is <code class="highlighter-rouge">1</code></li>
      <li>Assign the result to <code class="highlighter-rouge">fn</code></li>
    </ul>
  </li>
  <li>Find the number of false positives
    <ul>
      <li>Find the number of items where <code class="highlighter-rouge">predictions</code> is <code class="highlighter-rouge">1</code>, and the corresponding entry in <code class="highlighter-rouge">loans["loan_status"]</code> is <code class="highlighter-rouge">0</code></li>
      <li>Assign the result to <code class="highlighter-rouge">fp</code></li>
    </ul>
  </li>
</ol>

<p>There is <strong>class imbalance</strong> in the <code class="highlighter-rouge">loan_status</code> column. There are <code class="highlighter-rouge">6</code> times as many loans that were paid off on time (<code class="highlighter-rouge">1</code>), than loans that weren’t paid off on time (<code class="highlighter-rouge">0</code>). This causes a major issue when we use accuracy as a metric. This is because due to the class imbalance, a classifier can predict <code class="highlighter-rouge">1</code> for every row, and still have high accuracy.</p>

<p>it’s important to always be aware of imbalanced classes in machine learning models, and to adjust your error metric accordingly. In this case, we don’t want to use accuracy, and should instead use metrics that tell us the number of false positives and false negatives.</p>

<p>This means that we should optimize for:</p>

<ul>
  <li>high recall (true positive rate)</li>
  <li>low fall-out (false positive rate)</li>
</ul>

<p>We can calculate false positive rate and true positive rate, using the numbers of true positives, true negatives, false negatives, and false positives.</p>

<ol>
  <li>False Positive Rate: “what percentage of my 1 predictions are incorrect?”
    <ul>
      <li>In this case, “what percentage of the loans that I fund would not be repaid?”</li>
    </ul>
  </li>
  <li>True Positive Rate: “what percentage of all the possible 1 predictions am I making?”
    <ul>
      <li>In this case, “what percentage of loans that could be funded would I fund?”</li>
    </ul>
  </li>
</ol>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Predict that all loans will be paid off on time</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">loans</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="c"># False positives</span>
<span class="n">fp_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">fp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">fp_filter</span><span class="p">])</span>

<span class="c"># True positives</span>
<span class="n">tp_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">tp_filter</span><span class="p">])</span>

<span class="c"># False negatives</span>
<span class="n">fn_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">fn_filter</span><span class="p">])</span>

<span class="c"># True negatives</span>
<span class="n">tn_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">tn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">tn_filter</span><span class="p">])</span>

<span class="c"># Rates</span>
<span class="n">tpr</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
<span class="n">fpr</span> <span class="o">=</span> <span class="n">fp</span> <span class="o">/</span> <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">tn</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">tpr</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">fpr</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>1.0
1.0
</code></pre>
</div>

<p>both <code class="highlighter-rouge">fpr</code> and <code class="highlighter-rouge">tpr</code> were <code class="highlighter-rouge">1</code>. This is because we predicted <code class="highlighter-rouge">1</code> for each row. This means that we correctly identified all of the good loans (true positive rate), but we also incorrectly identified all of the bad loans (false positive rate). Now that we’ve setup error metrics, we can move on to making predictions using a machine learning algorithm.</p>

<h3 id="72-logistic-regression">7.2 Logistic Regression</h3>

<p>A good first algorithm to apply to binary classification problems is logistic regression, for the following reasons:</p>

<ul>
  <li>it’s quick to train and we can iterate more quickly,</li>
  <li>it’s less prone to overfitting than more complex models like decision trees,</li>
  <li>it’s easy to interpret.</li>
</ul>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s">"ignore"</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s">"scipy"</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"^internal gelsd"</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>

<span class="n">cols</span> <span class="o">=</span> <span class="n">loans</span><span class="o">.</span><span class="n">columns</span>
<span class="n">train_cols</span> <span class="o">=</span> <span class="n">cols</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">"loan_status"</span><span class="p">)</span>

<span class="n">features</span> <span class="o">=</span> <span class="n">loans</span><span class="p">[</span><span class="n">train_cols</span><span class="p">]</span>

<span class="n">target</span> <span class="o">=</span> <span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span>

<span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
</code></pre>
</div>

<p>In order to get a realistic depiction of the accuracy of the algorithm, we’ll need to use <code class="highlighter-rouge">cross validation</code> to generate predictions. Cross validation splits the dataset into groups, then makes predictions on each group using the other groups as training data. This ensures that we don’t overfit by generating predictions on the same data that we train our algorithm with.</p>

<p>We can perform cross validation using the <code class="highlighter-rouge">cross_val_predict</code> method of scikit-learn:</p>

<ol>
  <li>
    <p>cross_val_predict allows us to pass in a classifier, the features, and the target.</p>
  </li>
  <li>
    <p>We will create an instance of <code class="highlighter-rouge">KFold</code>, which will perform <code class="highlighter-rouge">3</code> fold cross validation across our dataset. We set <code class="highlighter-rouge">random_state</code> to <code class="highlighter-rouge">1</code> to ensure that the folds are always consistent, and we can compare scores between runs. If we don’t, each fold will be randomized every time, making it hard to tell if we’re improving our model or not.</p>
  </li>
  <li>
    <p>We can pass the instance of <code class="highlighter-rouge">KFold</code> into <code class="highlighter-rouge">cross_val_predict</code>, and it will then perform <code class="highlighter-rouge">3</code> fold cross validation to generate unbiased predictions.</p>
  </li>
</ol>

<p>Once we have cross validated predictions, we can compute true positive rate and false positive rate.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_predict</span><span class="p">,</span> <span class="n">KFold</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
<span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">cross_val_predict</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kf</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

<span class="c"># False positives.</span>
<span class="n">fp_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">fp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">fp_filter</span><span class="p">])</span>

<span class="c"># True positives.</span>
<span class="n">tp_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">tp_filter</span><span class="p">])</span>

<span class="c"># False negatives.</span>
<span class="n">fn_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">fn_filter</span><span class="p">])</span>

<span class="c"># True negatives</span>
<span class="n">tn_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">tn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">tn_filter</span><span class="p">])</span>

<span class="c"># Rates</span>
<span class="n">tpr</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
<span class="n">fpr</span> <span class="o">=</span> <span class="n">fp</span> <span class="o">/</span> <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">tn</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">tpr</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">fpr</span><span class="p">)</span>
</code></pre>
</div>

<p>0.9988517209077449<br />
0.9969723953695458</p>

<h4 id="penalizing-the-classifier">Penalizing The Classifier</h4>

<p>Our classifier is not accounting for the imbalance in the classes and we need to tell the classifier to penalize misclassifications of the less prevalent class more than the other class.</p>

<p>We can do this by setting the <code class="highlighter-rouge">class_weight</code> parameter to <code class="highlighter-rouge">balanced</code> when creating the LogisticRegression instance. This tells scikit-learn to penalize the misclassification of the minority class during the training process. The penalty means that the logistic regression classifier pays more attention to correctly classifying rows where <code class="highlighter-rouge">loan_status</code> is <code class="highlighter-rouge">0</code>. This lowers accuracy when <code class="highlighter-rouge">loan_status</code> is <code class="highlighter-rouge">1</code>, but raises accuracy when <code class="highlighter-rouge">loan_status</code> is <code class="highlighter-rouge">0</code>.</p>

<p>By setting the class_weight parameter to balanced, the penalty is set to be inversely proportional to the class frequencies. This would mean that for the classifier, correctly classifying a row where <code class="highlighter-rouge">loan_status</code> is <code class="highlighter-rouge">0</code> is 6 times more important than correctly classifying a row where <code class="highlighter-rouge">loan_status</code> is <code class="highlighter-rouge">1</code>.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.cross_validation</span> <span class="kn">import</span> <span class="n">cross_val_predict</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s">"balanced"</span><span class="p">)</span>
<span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">cross_val_predict</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kf</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

<span class="c"># False positives.</span>
<span class="n">fp_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">fp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">fp_filter</span><span class="p">])</span>

<span class="c"># True positives.</span>
<span class="n">tp_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">tp_filter</span><span class="p">])</span>

<span class="c"># False negatives.</span>
<span class="n">fn_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">fn_filter</span><span class="p">])</span>

<span class="c"># True negatives</span>
<span class="n">tn_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">tn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">tn_filter</span><span class="p">])</span>

<span class="c"># Rates</span>
<span class="n">tpr</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
<span class="n">fpr</span> <span class="o">=</span> <span class="n">fp</span> <span class="o">/</span> <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">tn</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">tpr</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">fpr</span><span class="p">)</span>
</code></pre>
</div>

<p>0.6744024416039646<br />
0.39269813000890474</p>

<h4 id="manual-penalties">Manual Penalties</h4>

<p>We significantly improved false positive rate by balancing the classes, which reduced true positive rate. Our true positive rate is now around <code class="highlighter-rouge">67%</code>, and our false positive rate is around <code class="highlighter-rouge">40%</code>. From a conservative investor’s standpoint, it’s reassuring that the false positive rate is lower because it means that we’ll be able to do a better job at avoiding bad loans than if we funded everything. However, we’d only ever decide to fund <code class="highlighter-rouge">67%</code> of the total loans (true positive rate), so we’d immediately reject a good amount of loans.</p>

<p>We can try to lower the false positive rate further by assigning a harsher penalty for misclassifying the negative class. While setting class_weight to balanced will automatically set a penalty based on the number of <code class="highlighter-rouge">1s</code> and <code class="highlighter-rouge">0s</code> in the column, we can also set a manual penalty. In the last screen, the penalty scikit-learn imposed for misclassifying a <code class="highlighter-rouge">0</code> would have been around <code class="highlighter-rouge">5.89</code> (since there are <code class="highlighter-rouge">5.89</code> times as many <code class="highlighter-rouge">1s</code> as <code class="highlighter-rouge">0s</code>).</p>

<p>We can also specify a penalty manually if we want to adjust the rates more. To do this, we need to pass in a dictionary of penalty values to the <code class="highlighter-rouge">class_weight</code> parameter:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.cross_validation</span> <span class="kn">import</span> <span class="n">cross_val_predict</span>
<span class="n">penalty</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="n">penalty</span><span class="p">)</span>
<span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">cross_val_predict</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kf</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

<span class="c"># False positives.</span>
<span class="n">fp_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">fp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">fp_filter</span><span class="p">])</span>

<span class="c"># True positives.</span>
<span class="n">tp_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">tp_filter</span><span class="p">])</span>

<span class="c"># False negatives.</span>
<span class="n">fn_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">fn_filter</span><span class="p">])</span>

<span class="c"># True negatives</span>
<span class="n">tn_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">tn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">tn_filter</span><span class="p">])</span>

<span class="c"># Rates</span>
<span class="n">tpr</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
<span class="n">fpr</span> <span class="o">=</span> <span class="n">fp</span> <span class="o">/</span> <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">tn</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">tpr</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">fpr</span><span class="p">)</span>
</code></pre>
</div>

<p>0.23340283443628562<br />
0.08637577916295637</p>

<p>It looks like assigning manual penalties lowered the false positive rate to around <code class="highlighter-rouge">8%</code>, and thus lowered our risk. Note that this comes at the expense of true positive rate. While we have fewer false positives, we’re also missing opportunities to fund more loans and potentially make more money. Given that we’re approaching this as a conservative investor, this strategy makes sense, but it’s worth keeping in mind the tradeoffs.</p>

<h1 id="8-random-forest">8. Random Forest</h1>

<p>Random Forests are able to work with nonlinear data, and learn complex conditionals. Logistic Regressions are only able to work with linear data. Training a Random Forest algorithm may enable us to get more accuracy due to columns that correlate nonlinearly with <code class="highlighter-rouge">loan_status</code>.</p>

<p>We can use the <code class="highlighter-rouge">RandomForestClassifer</code> class from scikit-learn to do this:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.cross_validation</span> <span class="kn">import</span> <span class="n">cross_val_predict</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s">"balanced"</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">cross_val_predict</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kf</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

<span class="c"># False positives.</span>
<span class="n">fp_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">fp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">fp_filter</span><span class="p">])</span>

<span class="c"># True positives.</span>
<span class="n">tp_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">tp_filter</span><span class="p">])</span>

<span class="c"># False negatives.</span>
<span class="n">fn_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">fn_filter</span><span class="p">])</span>

<span class="c"># True negatives</span>
<span class="n">tn_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loans</span><span class="p">[</span><span class="s">"loan_status"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">tn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">tn_filter</span><span class="p">])</span>

<span class="c"># Rates</span>
<span class="n">tpr</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
<span class="n">fpr</span> <span class="o">=</span> <span class="n">fp</span> <span class="o">/</span> <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">tn</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">tpr</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">fpr</span><span class="p">)</span>
</code></pre>
</div>

<p>0.971806726498051<br />
0.9330365093499555</p>

<h1 id="9-results">9. Results</h1>

<p>Unfortunately, using a RandomForestClassifier didn’t improve our false positive rate. The model is likely weighting too heavily on the <code class="highlighter-rouge">1</code> class, and still mostly predicting <code class="highlighter-rouge">1s</code>. We could fix this by applying a harsher penalty for misclassifications of <code class="highlighter-rouge">0s</code>.</p>

<p>Ultimately, our best model had a false positive rate of <code class="highlighter-rouge">8%</code>, and a true positive rate of <code class="highlighter-rouge">23%</code>. For a conservative investor, this means that they make money as long as the interest rate is high enough to offset the losses from <code class="highlighter-rouge">8%</code> of borrowers defaulting, and that the pool of <code class="highlighter-rouge">23%</code> of borrowers is large enough to make enough interest money to offset the losses.</p>

<p>If we had randomly picked loans to fund, borrowers would have defaulted on <code class="highlighter-rouge">14.5%</code> of them, and our model is better than that, although we’re excluding more loans than a random strategy would.</p>

<h1 id="9-recommendations">9. Recommendations</h1>

<ol>
  <li>We can tweak the penalties further.</li>
  <li>We can try models other than a random forest and logistic regression.</li>
  <li>We can use some of the columns we discarded to generate better features.</li>
  <li>We can ensemble multiple models to get more accurate predictions.</li>
  <li>We can tune the parameters of the algorithm to achieve higher performance.</li>
</ol>

    </article>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="http://localhost:4000/assets/js/validator.js"></script>
<script src="/assets/js/app.js"></script>

    </section>
  </body>
</html>
